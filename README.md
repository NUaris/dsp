# 空气声纳系统优化报告

## 优化版本: airSonar_optimized.py

### 问题解决方案

#### 1. 性能优化 (解决卡顿问题)

**主要优化措施:**

- **减少绘图频率**: 
  - 波形图每3次测量更新一次 (`PLOT_UPDATE_INTERVAL = 3`)
  - 频谱图每5次测量更新一次 (`SPECTRUM_UPDATE_INTERVAL = 5`)
  - 添加最小更新间隔限制 (100ms)

- **降低计算复杂度**:
  - IIR滤波器阶数从8降到6
  - FIR滤波器长度从101降到61
  - 历史数据点数限制为100个 (`MAX_HIST_POINTS = 100`)

- **预计算优化**:
  - 预计算FFT频率轴，避免重复计算
  - 缓存计算结果

- **Kalman滤波器参数调优**:
  - 降低过程噪声 (`q=0.005`) 和测量噪声 (`r=0.1`) 以提高响应速度

**预期性能提升**: 50-70%的帧率提升，显著减少界面卡顿

#### 2. 原始频谱显示

**实现方案:**
- 保持原始接收信号 `rx` 不经过滤波器处理
- 在 `_on_wave()` 函数中直接对原始 `rx` 信号进行FFT
- 将图表标题改为 "接收信号原始频谱 (未滤波)" 以明确显示内容
- 高亮显示三个频段区域，便于观察信号分布

**技术细节:**
```python
# 原始频谱计算 (未滤波)
f2 = np.fft.rfftfreq(rx.size, 1/FS)
spec2 = mag2db(np.fft.rfft(rx))  # 直接对原始信号做FFT
```

#### 3. 多频融合/置信度加权

**SNR计算方法:**
- 改进峰检测函数 `first_strong_peak()` 返回SNR值
- SNR = 峰值幅度 / 噪声底 (基于中位数估计)
- 降低检测阈值从6σ到4σ以提高灵敏度

**置信度评估:**
```python
def calculate_band_confidence(snr, amplitude, band_idx):
    snr_weight = min(snr / 10.0, 1.0)      # SNR权重 (50%)
    amp_weight = min(amplitude / 0.1, 1.0)  # 幅度权重 (30%)
    freq_weights = [0.8, 1.0, 0.9]         # 频段权重 (20%)
    confidence = snr_weight * 0.5 + amp_weight * 0.3 + freq_weight * 0.2
```

**加权融合策略:**
- 计算每个频段的置信度
- 使用置信度作为权重进行加权平均
- 记录各频段SNR值到CSV文件
- 实时显示综合置信度和各频段SNR

**可视化改进:**
- 历史曲线根据置信度显示不同颜色:
  - 红色: 置信度 < 30% (低可信)
  - 橙色: 30% ≤ 置信度 < 70% (中等可信)
  - 绿色: 置信度 ≥ 70% (高可信)
- 添加置信度标签显示实时置信度和SNR信息

### 新增功能

1. **实时置信度监控**: GUI上显示当前测量的置信度百分比和各频段SNR
2. **增强数据记录**: CSV文件记录置信度和SNR信息用于后续分析
3. **自适应显示**: 根据数据变化自动调整更新频率
4. **改进的错误处理**: 更好的异常处理和日志记录

### 使用方法

1. 运行优化版本:
   ```bash
   python airSonar_optimized.py
   ```

2. 观察改进效果:
   - 界面应该更加流畅，不再卡顿
   - 右上角显示 "接收信号原始频谱 (未滤波)"
   - 距离显示旁边显示置信度信息
   - 历史曲线用颜色编码显示置信度

3. 性能监控:
   - 查看日志了解各频段SNR值
   - 观察置信度变化判断测量质量
   - 根据需要调整环境温度补偿

### 技术参数调整

如需进一步调优，可修改以下参数:

```python
# 性能参数
PLOT_UPDATE_INTERVAL = 3      # 波形更新间隔
SPECTRUM_UPDATE_INTERVAL = 5  # 频谱更新间隔
MAX_HIST_POINTS = 100        # 历史点数

# 置信度计算权重
snr_weight = 0.5    # SNR权重
amp_weight = 0.3    # 幅度权重  
freq_weight = 0.2   # 频段权重
```

### 预期效果

1. **性能提升**: 界面响应速度提升50-70%，不再出现卡顿
2. **信息更全面**: 能看到原始频谱，了解环境噪声情况
3. **测量更可靠**: 通过置信度加权，自动筛选最可靠的频段数据
4. **调试更容易**: 实时SNR监控帮助判断测量质量和环境影响
